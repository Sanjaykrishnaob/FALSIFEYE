from reportlab.lib.pagesizes import letter
from reportlab.lib import colors
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, Image
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import inch
import os
import datetime

def generate_report(case_id, evidence_name, analysis_results, output_path, file_hash="N/A"):
    """
    Generates a professional PDF forensic report using Platypus.
    Includes Chain of Custody and Digital Fingerprinting for legal readiness.
    """
    doc = SimpleDocTemplate(output_path, pagesize=letter)
    styles = getSampleStyleSheet()
    story = []

    # --- Title ---
    title_style = styles['Title']
    title_style.textColor = colors.HexColor('#2c3e50')
    story.append(Paragraph("FALSIFEYE Forensic Report", title_style))
    story.append(Spacer(1, 0.2 * inch))

    # --- Meta Data Table ---
    data = [
        ["Case ID:", case_id],
        ["Evidence File:", evidence_name],
        ["Digital Fingerprint (SHA-256):", Paragraph(file_hash, styles['Normal'])], # Wrap hash in Paragraph for wrapping
        ["Date:", datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")],
        ["Generated By:", "FALSIFEYE Automated System"]
    ]
    
    t = Table(data, colWidths=[2*inch, 4*inch])
    t.setStyle(TableStyle([
        ('FONTNAME', (0,0), (0,-1), 'Helvetica-Bold'),
        ('TEXTCOLOR', (0,0), (0,-1), colors.HexColor('#34495e')),
        ('ALIGN', (0,0), (-1,-1), 'LEFT'),
        ('VALIGN', (0,0), (-1,-1), 'TOP'),
        ('BOTTOMPADDING', (0,0), (-1,-1), 6),
        ('GRID', (0,0), (-1,-1), 0.25, colors.lightgrey),
    ]))
    story.append(t)
    story.append(Spacer(1, 0.3 * inch))

    # --- Authenticity Score ---
    score = analysis_results.get('score', 0)
    score_color = colors.green if score < 50 else colors.red
    verdict = "LIKELY AUTHENTIC" if score < 50 else "POTENTIAL MANIPULATION DETECTED"
    
    story.append(Paragraph(f"Authenticity Score: {score}/100", 
                           ParagraphStyle('Score', parent=styles['Heading2'], textColor=score_color)))
    story.append(Paragraph(f"Verdict: {verdict}", styles['Normal']))
    story.append(Spacer(1, 0.2 * inch))

    # --- Detailed Analysis Section ---
    story.append(Paragraph("Detailed Analysis", styles['Heading2']))
    
    # Format details nicely
    details = analysis_results.get('details', 'No details provided.')
    # Split details by period or newlines if possible for better readability
    if isinstance(details, str):
        detail_lines = details.split('. ')
        for line in detail_lines:
            if line.strip():
                story.append(Paragraph(f"â€¢ {line.strip()}.", styles['Normal']))
                story.append(Spacer(1, 0.05 * inch))
    
    story.append(Spacer(1, 0.2 * inch))

    # --- Technical Metadata ---
    story.append(Paragraph("Technical Metadata", styles['Heading3']))
    meta_data = []
    for key, value in analysis_results.items():
        if key not in ['score', 'details', 'filename', 'report_path', 'transcription']:
            meta_data.append([key.replace('_', ' ').title(), str(value)])
    
    if meta_data:
        t_meta = Table(meta_data, colWidths=[2.5*inch, 3.5*inch])
        t_meta.setStyle(TableStyle([
            ('GRID', (0,0), (-1,-1), 0.5, colors.grey),
            ('BACKGROUND', (0,0), (0,-1), colors.whitesmoke),
            ('PADDING', (0,0), (-1,-1), 6),
        ]))
        story.append(t_meta)

    # --- Chain of Custody & Integrity ---
    story.append(Spacer(1, 0.3 * inch))
    story.append(Paragraph("Chain of Custody & Integrity", styles['Heading2']))
    custody_text = f"""
    This file was ingested into the FALSIFEYE system on {datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")}.
    The SHA-256 hash ({file_hash[:16]}...) was generated immediately upon receipt to ensure data integrity.
    All analysis was performed on the hashed artifact without modification.
    """
    story.append(Paragraph(custody_text, styles['Normal']))

    # --- Footer ---
    story.append(Spacer(1, 0.5 * inch))
    footer_text = "DISCLAIMER: This report is generated by an AI system. Results should be verified by a certified forensic expert. This document is admissible only as a preliminary screening report."
    story.append(Paragraph(footer_text, ParagraphStyle('Footer', parent=styles['Normal'], fontSize=8, textColor=colors.grey)))

    doc.build(story)
    return output_path
